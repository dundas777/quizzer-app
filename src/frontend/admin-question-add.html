<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Question - Quizzer Admin</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="header-placeholder"></div>
    <div class="container">
        <h1 data-testid="add-question-heading">Add New Question</h1>
        <form id="add-question-form">
            <div style="margin-bottom: 1.2em;">
                <label for="subjectSelect" style="display: inline-block; width: 120px;">Subject:</label>
                <select id="subjectSelect" data-testid="subject-select" required>
                </select>
                <br />
            </div>
            <div style="margin-bottom: 1.2em;">
                <label for="question" style="display: inline-block; width: 120px;">Question:</label>
                <input type="text" id="question" data-testid="question-input" style="display: inline-block; width: 400px;" required />
                <br />
            </div>
            <div style="margin-bottom: 1.2em;">
                <label for="answer1" style="display: inline-block; width: 120px;">Answer 1:</label>
                <input type="text" id="answer1" data-testid="answer1-input" name="answer1" required />
                <input id="isAnswer1Correct" data-testid="is-answer1-correct-radio" type="radio" name="isAnswerCorrect" required />
                <br />
            </div>
            <div style="margin-bottom: 1.2em;">
                <label for="answer2" style="display: inline-block; width: 120px;">Answer 2:</label>
                <input type="text" id="answer2" data-testid="answer2-input" name="answer2" required />
                <input id="isAnswer2Correct" data-testid="is-answer2-correct-radio" type="radio" name="isAnswerCorrect" />
                <br />
            </div>
            <div style="margin-bottom: 1.2em;">
                <label for="answer3" style="display: inline-block; width: 120px;">Answer 3:</label>
                <input type="text" id="answer3" data-testid="answer3-input" name="answer3" required />
                <input id="isAnswer3Correct" data-testid="is-answer3-correct-radio" type="radio" name="isAnswerCorrect" />
                <br />
            </div>
            <div style="margin-bottom: 1.2em;">
                <label for="answer4" style="display: inline-block; width: 120px;">Answer 4:</label>
                <input type="text" id="answer4" data-testid="answer4-input" name="answer4" required />
                <input id="isAnswer4Correct" data-testid="is-answer4-correct-radio" type="radio" name="isAnswerCorrect" />
                <br />
            </div>
            <div>
                <input id="isAnswerCorrectGuide" data-testid="isAnswerCorrectGuide-radio" type="radio" name="isAnswerCorrectGuide" />
                <span style="font-size: 0.9em; color: gray;">(Select the radio button next to the correct answer)</span>
            </div>
            <br />
            <button id="save-button" type="submit" class="button" data-testid="save-button">Save</button>
            <button id="cancel-button" type="button" class="linkButtonLight" data-testid="cancel-button">Cancel</button>
            <br />
        </form>
    </div>

    <script src="include-header.js"></script>
    <script src="admin-check.js"></script>
    <script type="module">

        import { questionsApiEndpoint, subjectsApiEndpoint } from './constants.js';
        import { capitalise } from './utils.js';
        const urlParams = new URLSearchParams(window.location.search);
        const questionId = urlParams.get('id');

        // populate subject dropdown
        await fetch(`${subjectsApiEndpoint}`)
            .then(response => response.json())
            .then(data => {
                console.log('Fetched subjects:', data);
                const subjects = data;
                const subjectSelect = document.getElementById('subjectSelect');
                subjects.forEach((subject, index) => {
                    const selectOption = document.createElement('option');
                    selectOption.value = subject;
                    selectOption.textContent = capitalise(subject);
                    selectOption.setAttribute('data-testid', `${subject}-option`);
                    subjectSelect.appendChild(selectOption);
                });
            });

        // cancel button handler
        document.getElementById('cancel-button').addEventListener('click', function(e) {
            window.location.href = 'admin-question-list.html';
        });

        // submit button handler to create new question
        document.getElementById('add-question-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const subject = document.getElementById('subjectSelect').value;
            const questionText = document.getElementById('question').value;
            const answers = [
                document.getElementById('answer1').value,
                document.getElementById('answer2').value,
                document.getElementById('answer3').value,
                document.getElementById('answer4').value
            ];
            const correctAnswerIndex = [
                document.getElementById('isAnswer1Correct').checked,
                document.getElementById('isAnswer2Correct').checked,
                document.getElementById('isAnswer3Correct').checked,
                document.getElementById('isAnswer4Correct').checked
            ].findIndex(v => v === true);

            const payload = {
                subject: subject,
                question: questionText,
                answers: answers,
                correctAnswerIdx: correctAnswerIndex >= 0 ? correctAnswerIndex : 0
            };

            try {
                const resp = await fetch(questionsApiEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (resp.ok) {
                    alert('Question added successfully');
                    window.location.href = 'admin-question-list.html';
                } else {
                    const text = await resp.text();
                    alert('Failed to add question: ' + text);
                }
            } catch (err) {
                console.error('Error adding question:', err);
                alert('Error adding question. See console for details.');
            }
        });


    </script>
</body>
</html>